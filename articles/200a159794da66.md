---
title: "Bufã‚’åˆ©ç”¨ã—ã¦ã€Grpcã‚µãƒ¼ãƒ(Go)ã‚’çˆ†é€Ÿã§ä½œæˆã™ã‚‹ï¼"
emoji: "ğŸ“‘"
type: "tech"
topics:
  - "go"
  - "protobuf"
  - "buf"
  - "proto"
  - "groc"
published: true
published_at: "2024-07-03 18:55"
---

# ç›®çš„
ä»¥å‰ã¾ã§ã€protocã®ã¿åˆ©ç”¨ã—ã¦protoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Goã¸ã®å¤‰æ›ã‚’è¡Œãªã£ã¦ã„ãŸã€‚ã—ã‹ã—,ãƒ‘ã‚¹ãŒé–“é•ã£ãŸã‚Šã€è¨˜è¿°æ–¹æ³•(å¤‰æ•°åãªã©ï¼‰ãŒã‚ã‹ãªã‹ã£ãŸã‚Šã€è¤‡æ•°ã®protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€åº¦ã«goã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒå¤§å¤‰ã ã£ãŸ(makefileãªã©ã«è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ).ã€€ãã®ãŸã‚protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦Bufã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã—ãŸ. 
# Bufã¨ã¯
ä¸€è¨€ã§è¨€ã†ã¨
protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹CLI(é«˜æ€§èƒ½ãªProtocbufã‚³ãƒ³ãƒ‘ã‚¤ãƒ©)
- æ–‡æ³•ã®ã‚¨ãƒ©ãƒ¼æ¤œå‡º
- lintæ©Ÿèƒ½(ãƒãƒ¼ãƒ ã§ãƒ«ãƒ¼ãƒ«ã‚’çµ±ä¸€ã™ã‚‹ã“ã¨ãŒã§ãã‚‹)
- è¨­å®šå¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸºã¥ã„ã¦protocãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å‘¼ã³å‡ºã™ã‚³ãƒ¼ãƒ‰ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
# github
https://github.com/nagisa599/Go-Grpc-Template

# å®Ÿè£…
## packageã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
brew install bufbuild/buf/buf
```

## buf.yamlãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
```yaml:buf.yaml
version: v1
# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å
name: buf.build/tutorials/lint
# lintè¨­å®š
lint:
  use:
    - DEFAULT # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨
```

## Protobufãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ(schemaã®ä½œæˆ)
```Protobuf:todo.proto
syntax = "proto3";

package proto.todo.v1;

// Defines the Todo service
service TodoService {
    // Defines a method to get a todo item
    rpc GetTodo (GetTodoRequest) returns (GetTodoResponse); 
    // Defines a method to create a todo item
    rpc CreateTodo (CreateTodoRequest) returns (CreateTodoResponse);
}

// Response message for getting a todo item
message GetTodoResponse {
    int32 id = 1;
    string title = 2;
    string description = 3;
}

// Request message for getting a todo item
message GetTodoRequest {
    int32 id = 1;
}

// Response message for creating a todo item
message CreateTodoResponse {
    int32 id = 1;
    string title = 2;
    string description = 3;
}

// Request message for creating a todo item
message CreateTodoRequest {
    string title = 1;
    string description = 2;
}
```

## buf.gen.yamlãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
```yaml:buf.gen.yaml
version: v1
# ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹
managed:
  enabled: true
  go_package_prefix:
    default: github.com/JY8752/buf-demo/example/gen # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®packageåã‚’æŒ‡å®šã€‚ã“ã‚Œã¯å¿…é ˆ
plugins:
  # protoc-gen-goãƒ—ãƒ©ã‚°ã‚¤ãƒ³
  # - plugin: go
  #   out: gen/go
  #   opt: paths=source_relative
  # ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨
  - plugin: buf.build/protocolbuffers/go:v1.31.0
    out: gen/go
    # Goã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹ãŒProtobufãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç›¸å¯¾çš„ã«è§£æ±ºã•ã‚Œã‚‹ã‚ˆã†æŒ‡å®š
    # ãªãã¦ã‚‚ã„ã„ãŒãªã„ã¨ä¸Šã§æŒ‡å®šã—ãŸdefaultã®ãƒ•ãƒ«ãƒ‘ã‚¹ãŒä½¿ã‚ã‚Œã‚‹
    opt: paths=source_relative
  # protoc-gen-go-grpcãƒ—ãƒ©ã‚°ã‚¤ãƒ³
  - plugin: buf.build/grpc/go:v1.3.0
    out: gen/go
    opt: paths=source_relative
```
## protoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰goã‚’ç”Ÿæˆ
```
buf generate proto
```

## gRPCã‚µãƒ¼ãƒã®å®Ÿè£…
```go:main.go
package main

import (
	"fmt"
	"log"
	"net"
	"os"
	"os/signal"

	"todoService/cmd/server/controller"
	todov1 "todoService/gen/go/todo/v1"

	"google.golang.org/grpc"
)

// è‡ªä½œã‚µãƒ¼ãƒ“ã‚¹æ§‹é€ ä½“ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å®šç¾©

func main() {
	// 1. 8080ç•ªportã®Lisnterã‚’ä½œæˆ
	port := 8080
	listener, err := net.Listen("tcp", fmt.Sprintf(":%d", port))
	if err != nil {
		panic(err)
	}
	grpcTaskController := controller.NewGrpcController()
	// 2. gRPCã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆ
	s := grpc.NewServer()
	todov1.RegisterTodoServiceServer(s, grpcTaskController)
	// 3. ä½œæˆã—ãŸgRPCã‚µãƒ¼ãƒãƒ¼ã‚’ã€8080ç•ªãƒãƒ¼ãƒˆã§ç¨¼åƒã•ã›ã‚‹
	go func() {
		log.Printf("start gRPC server port: %v", port)
		s.Serve(listener)
	}()

	// 4.Ctrl+CãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰Graceful shutdownã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, os.Interrupt)
	<-quit
	log.Println("stopping gRPC server...")
	s.GracefulStop()
}
```
```go:todo_controller.go
package controller

import (
	"context"
	todov1 "todoService/gen/go/todo/v1"
)

type grpcTodoController struct {
	todov1.UnimplementedTodoServiceServer
}

func NewGrpcController() *grpcTodoController {
	return &grpcTodoController{}
}

func (s *grpcTodoController) GetTodo(ctx context.Context, req *todov1.GetTodoRequest) (*todov1.GetTodoResponse, error) {
	return &todov1.GetTodoResponse{
		Id: 1,
		Title: "title",
		Description: "description",
	}, nil
}
```

## postmanã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆ
![](https://storage.googleapis.com/zenn-user-upload/1642365e2dae-20240703.png)

