---
title: "Nextjs(App Router)âœ–ï¸Nest(graphql)âœ–ï¸Auth0ã‚’ç”¨ã„ãŸèªè¨¼åŸºç›¤ã®ä½œæˆã€€ã€œå®Ÿè£…ç·¨ã€œ"
emoji: "ğŸ’¡"
type: "tech"
topics:
  - "graphql"
  - "nextjs"
  - "typescript"
  - "auth0"
published: true
published_at: "2024-05-23 20:33"
---

# å‰æçŸ¥è­˜

https://zenn.dev/naginagi124/articles/f28fadec5a661d

# æŠ€è¡“é¸å®š

ä»Šå›ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã« Nextjs(App router)ã¨ backend ã« Nest(graphql)ã€èªè¨¼åŸºç›¤ã« Auth0 ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã€‚

# github

https://github.com/nagisa599/WebAuth0Template

# å®Ÿè£…

## Auth0 ã®è¨­å®š

#### Applicaton ã‚’ä½œæˆ

![](https://storage.googleapis.com/zenn-user-upload/c7a004472800-20240506.png)

#### Application ã®ç¨®é¡ã‚’é¸æŠ

Application ã®ç¨®é¡ã¯ã€Regluar Web Application ã‚’é¸æŠã€‚ç†ç”±ã¨ã—ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã« Nextjs ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ãŸã‚

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã« React ã®ã¿ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€Single Web Page Application ã‚’é¸æŠã™ã‚‹ã“ã¨
  ![](https://storage.googleapis.com/zenn-user-upload/c466e431b7b0-20240506.png)

#### è©³ç´°è¨­å®š

Application ã® setting ã‹ã‚‰ä»¥ä¸‹ã®é …ç›®ã‚’è¿½åŠ ã€‚ã“ã¡ã‚‰ã® url ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã™ã‚‹ url ã§ã‚ã‚‹ãŸã‚å„è‡ªã§é©æ™‚å¤‰æ›´ã‚’ã—ã¦ã»ã—ã„ã€‚ä»Šå›ã¯ nextjs (app router)ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§å‹•ãã‚ˆã†ã«ã—ã¦ã„ã‚‹ãŸã‚ã€åˆã‚ã¦ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹éš›ã¯ã€ã“ã®ã¾ã¾ã§è‰¯ã„ã€‚
![](https://storage.googleapis.com/zenn-user-upload/827db002949c-20240506.png)

Allow callback url => http://localhost:3000/api/auth/callback
Allowed logtout url => http://localhost:3000

æ³¨æ„ã™ã‚‹å†…å®¹ã¨ã—ã¦ã¯ã€é–‹ç™ºç”¨ã®è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰ã®ãŸã‚æœ¬ç•ªç’°å¢ƒã®æ™‚ã¯ã€é©æ™‚ url ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨

## NextJS ã‚’è¨­å®š

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```
npx create-next-app {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå} --ts
```

- ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã¨ã„ãã¤ã‹ã®é¸æŠè‚¢ãŒå‡ºã¦ãã‚‹ãŒå¿…ãš app router ã‚’é¸æŠã™ã‚‹ã“ã¨ï¼ˆpage router ã¯é¸æŠã—ãªã„ã“ã¨ï¼‰

#### env ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜è¼‰

```
AUTH0_SECRET=KEY-VALUE
AUTH0_BASE_URL=http://localhost:3000
AUTH0_ISSUER_BASE_URL=https://AUTH0-DOMAIN
AUTH0_CLIENT_ID=AUTH0-CLIENT-ID
AUTH0_CLIENT_SECRET=AUTH0-CLIENT-SECRET
NEXT_PUBLIC_BACKEND_URL=http://localhost:3001
```

#### api ã®è¨˜è¼‰

##### auth0 ã«ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã¨ãã® api

app/api/auth/[auth0]/route.ts ã‚’ä½œæˆ

```
import { handleAuth, handleLogin } from "@auth0/nextjs-auth0";

export const GET = handleAuth({
  login: handleLogin({
    returnTo: "/profile",
    authorizationParams: {
      audience: "http://localhost:3001",
      // scope: "openid profile email", // ä¾‹ã¨ã—ã¦ scope ã‚’è¿½åŠ 
    },
  }),
  signup: handleLogin({
    authorizationParams: {
      screen_hint: "signup",
    },
    returnTo: "/profile",
  }),
});
```

##### backend ã«å©ãéš›ã® proxy ã‚µãƒ¼ãƒã®å®Ÿè£…(api route ã§å®Ÿè£…ï¼‰

æµã‚Œã¨ã—ã¦ã¯ã€client ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸã‚‚ã®ã‚’ backend ã«æ¸¡ã›ã‚‹ã‚ˆã†ã« request ã‚’å¤‰æ›ã™ã‚‹ã€‚ä»Šå›ã¯ cookie ã‹ã‚‰ accessToken ã‚’å–ã‚Šå‡ºã—ã¦ã€authorization ã¨ã„ã† header ã« accessToken ã‚’è¨­å®šã—ã¦ request ã—ã¦ã„ã‚‹ã€‚ã‚‚ã¡ã‚ã‚“é€†ã‚‚ç„¶ã‚Šã§å¸°ã£ã¦ããŸ response ã¯ã€nextjs ã®å‹ã§ã¯ãªã„ã®ã§ NextResponse å‹ã¨ã—ã¦è¿”ã™ã“ã¨ã«ã—ã¦ã„ã‚‹ã€‚app router ã§ã¯ next-http-proxy-middleware ã¨å¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸãŸã‚ api route ã«ç‹¬è‡ªã® proxy ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
https://zenn.dev/mh4gf/articles/urql-client-working-with-credential-in-nextjs#fn-c960-2
app/api/auth/[auth0]/route.ts

```
import { getAccessToken } from "@auth0/nextjs-auth0";
import { NextRequest, NextResponse } from "next/server";
import fetch from "node-fetch";
export async function POST(request: NextRequest) {
  // NextRequestã¯é€šå¸¸ã®Requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã•ã¾ã–ã¾ãªæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã‚‚ã®
  const res = new NextResponse();
  // cookieã‹ã‚‰acce
  const { accessToken } = await getAccessToken(request, res);
  // ReadableStream ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ› (requestbodyã‚’å–å¾—ã™ã‚‹ãŸã‚)
  const requestBody = await request.text();
  // objectã«å¤‰æ›
  const { query, variables } = JSON.parse(requestBody) as {
    query: string;
    variables?: any;
  };
  const graphqlResponse = await fetch("http://localhost:3001/graphql", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${accessToken}`, // Bearerãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
    },
    // bodyã¯æ–‡å­—åˆ—å‡ºãªã„ã¨ã„ã‘ãªã„ãŸã‚
    body: JSON.stringify({ query, variables }), // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  });
  const responseBody = await graphqlResponse.text();
  // clientã«è¿”ã™ãŸã‚ã®å‹ã«ç”Ÿæˆã—ç›´ã™ã€‚
  return new Response(responseBody, {
    status: graphqlResponse.status,
    statusText: graphqlResponse.statusText,
  });
}
```

#### ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®å®Ÿè£…

##### ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å®Ÿè£…

```
export const SignupButton = () => {
  return (
    <a className="button__sign-up" href="/api/auth/signup">
      Sign Up
    </a>
  );
};
```

##### ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å®Ÿè£…

```
export const LoginButton = () => {
  return (
    <a className="button__login" href="/api/auth/login">
      Log In
    </a>
  );
};
```

##### ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®å®Ÿè£…

```
export const LogoutButton = () => {
  return (
    <a className="button__logout" href="/api/auth/logout">
      Log Out
    </a>
  );
};
```

#### middlreware ã®è¨­å®š

middlreware.ts

```
import { withMiddlewareAuthRequired } from "@auth0/nextjs-auth0/edge";

export default withMiddlewareAuthRequired();

export const config = {
  matcher: ["/profile", "/protect"],
};

```

#### UrqlApolloClient ã‚’ä½œæˆ

urqlClient ã®ä½œæˆ
å†…å®¹ã¯çœç•¥ã—ã¾ã—ãŸã€‚å¤šåˆ†ã»ã¼ã“ã®è¨­å®šãŒ better ãªã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚

```
"use client";
import { createClient, cacheExchange, fetchExchange, Provider } from "urql";

const client = createClient({
  // endpoint
  url: "http://localhost:3000/api/graphql",
  fetchOptions: {
    credentials: "include", // ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
  },
  exchanges: [cacheExchange, fetchExchange],
});

export function ApolloWrapper({ children }: React.PropsWithChildren) {
  return <Provider value={client}>{children}</Provider>;
}
```

## auth0 ã®è¨­å®š(API)

###### api ã‚’é¸æŠ

![](https://storage.googleapis.com/zenn-user-upload/6094189c0831-20240523.png)

##### create ã‚’é¸æŠ

![](https://storage.googleapis.com/zenn-user-upload/55b441997e0b-20240523.png)
// å„è‡ªèª¬æ˜ã«ã—ãŸãŒã£ã¦å¥½ããªå€¤ã‚’å…¥ã‚Œã¦ãã ã•ã„
![](https://storage.googleapis.com/zenn-user-upload/90abe6087fa6-20240523.png)

## Nest ã®è¨­å®š

### .env ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š

AUTH0_AUDIENCE ã¯ã€AUTH0(APIï¼‰ã§è¨­å®šã—ãŸ Indetifer ã‚’è¨­å®šã™ã‚‹
AUTH0_ISSUER_URL

```
AUTH0_ISSUER_URL=***
AUTH0_AUDIENCE=***
```

### jwt-auth-gurad ã®ä½œæˆ

canActivate ã¯ NestJS ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ãŠã„ã¦ã€ç‰¹å®šã®ãƒ«ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã™ã‚‹ CanActivate ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®ä¸€éƒ¨ã§ã™.ã“ã‚Œã«ã‚ˆã‚Šãƒ•ãƒ­ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§é€ã‚‰ã‚Œã¦ããŸ accessToken ã‚’å–å¾—ã—ã¾ã™ã€‚æµã‚Œã¯ã‚³ãƒ¡ãƒ³ãƒˆã§æ›¸ã„ã¦ã„ã¾ã™ã€‚

```
import {
  CanActivate,
  ExecutionContext,
  Injectable,
  UnauthorizedException,
} from '@nestjs/common';
import * as jwt from 'jsonwebtoken';
import * as jwksClient from 'jwks-rsa';
import * as dotenv from 'dotenv';
dotenv.config();

@Injectable()
export class AuthGuard implements CanActivate {
  // å…¬é–‹éµãŒå–å¾—ã§ãã‚‹urlã‚’æŒ‡å®š (jwtã®keyã‚’æ¸¡ã•ãªã„ã¨å–å¾—ã¯ã§ããªã„ã€‚ãƒ¦ãƒ¼ã‚¶ä¸€äººã«è¶³ã—ã¦ä¸€ã¤ã®å…¬é–‹éµãŒã‚ã‚‹ã‹ã‚‰keyã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã€‚)
  private client = jwksClient({
    jwksUri: `${process.env.AUTH0_ISSUER_URL}/.well-known/jwks.json`,
  });
  // canActivateã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€²è¡Œã™ã‚‹å‰ã«ç‰¹å®šã®æ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
  canActivate(context: ExecutionContext): Promise<boolean> {
    // contextã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ãŒå…¥ã£ã¦ã„ã‚‹ã€‚
    const ctx = context.getArgs()[2]; // GraphQL context
    const request = ctx.req; // Direct access to GraphQL request object
    const authHeader = request.headers.authorization;
    if (!authHeader) throw new UnauthorizedException('No token provided');
    // bearã¨ã„ã†å…ˆé ­ã®æ–‡å­—ãŒã‚ã‚‹ãŸã‚ãã‚Œã‚’å–ã‚Šé™¤ã
    const token = authHeader.split(' ')[1];
    return this.validateToken(token).then((decoded) => {
      // Here you can use the user ID from decoded JWT
      const userId = decoded.sub;
      // You can attach the user ID to the request object if needed
      // requestã«requestã®userIdã‚’è¿½åŠ ã™ã‚‹
      request.user = { userId };
      return true;
    });
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã‚’è¡Œã„ã€tokenã®æš—å·åŒ–ã‚’è§£ã
  private async validateToken(token: string): Promise<any> {
    // decodeãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
    // complete: trueã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒå«ã¾ã‚Œã‚‹
    // payloadã¯ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰éƒ¨åˆ†
    const decoded: any = jwt.decode(token, { complete: true });
    if (!decoded) throw new UnauthorizedException('Invalid token');
    const kid = decoded.header.kid;
    // keyIdã‚’æ¸¡ã—ã¦è‡ªåˆ†ã«å¯¾å¿œã™ã‚‹å…¬é–‹éµã‚’å–å¾—
    const key = await this.client.getSigningKey(kid);
    const signingKey = key.getPublicKey();
    try {
      // tokenãŒæ”¹ç«„ã•ã‚Œã¦ã„ãªã„ã‹ã®ç¢ºèª jwtã¨å…¬é–‹éµã€å—ã‘å–ã‚Šã¦ã®ç¢ºèªã€ç™ºè¡Œå…ƒã®ç¢ºèªã‚’ã—ã¦ã„ã‚‹
      jwt.verify(token, signingKey, {
        algorithms: ['RS256'],
        audience: process.env.AUTH0_AUDIENCE,
        issuer: `${process.env.AUTH0_ISSUER_URL}/`,
      });
      // payloadéƒ¨åˆ†é–‹ã‘ã‚’è¿”ã™ã€‚
      return decoded.payload; // Return the decoded payload
    } catch (err) {
      throw new UnauthorizedException('Invalid token');
    }
  }
}
```

### getUser

accessToken(jwt)ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨å¾—ã‚‰ã‚Œã‚‹ uid ã‚’ resolver ã§å–ã‚Šæ‰±ã†ãŸã‚ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

```
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const GetUser = createParamDecorator(
  (data: unknown, context: ExecutionContext) => {
    const ctx = context.getArgs()[2]; // GraphQLã®å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    return ctx.req.user; // `AuthGuard`ã§ã‚»ãƒƒãƒˆã•ã‚ŒãŸuserã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  },
);
```

### 2 ã¤ã®é–¢æ•°ã®ä½¿ã„æ–¹

```
import { Query, Resolver } from '@nestjs/graphql';
import { TodosService } from './todos.service';
import { UseGuards } from '@nestjs/common';

import { Todo } from 'src/graphql/graphql.schema';
// import { AuthGuard } from '@nestjs/passport';
import { AuthGuard } from 'src/auth/jwt-auth-guard';
import { GetUser } from 'src/auth/getuser';
@Resolver('Todo')
export class TodosResolvers {
  constructor(private readonly todosService: TodosService) {}

  @Query(() => [Todo])
  @UseGuards(AuthGuard) // JWTæˆ¦ç•¥ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†æŒ‡å®š
  async getTodos(@GetUser() user: any): Promise<Todo[]> {
    console.log('getTodos');
    console.log(user);
    // const userId = context.user.userId; // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰userIdã‚’å–å¾—
    // console.log('ã“ã¡ã‚‰ãƒªã‚¾ãƒ«ãƒãƒ¼ã§ã™', userId);
    const test = await this.todosService.getTodos();
    return [test];
  }
}

```

# ã¾ã¨ã‚

å€‹äººçš„ã«ã¯ã€ã‹ãªã‚Šè‡ªä¿¡ã®ã‚ã‚‹ã‚‚ã®ãŒä½œã‚Œã¾ã—ãŸã€‚github ã«ã‚‚å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ template ã¨ã—ã¦ä½¿ã£ã¦ã‚‚ã‚‰ãˆãŸã‚‰å¬‰ã—ã„ã§ã™ãƒ¼
https://github.com/nagisa599/WebAuth0Template

# å‚è€ƒæ–‡çŒ®

https://developer.auth0.com/resources/guides/web-app/nextjs/basic-authentication
